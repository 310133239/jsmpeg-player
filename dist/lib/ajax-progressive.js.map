{"version":3,"sources":["../../src/lib/ajax-progressive.js"],"names":["JSMpeg","AjaxProgressiveSource","url","options","destination","request","completed","established","progress","fileSize","loadedSize","chunkSize","isLoading","loadStartTime","throttled","aborted","prototype","connect","start","XMLHttpRequest","onreadystatechange","readyState","DONE","parseInt","getResponseHeader","loadNextChunk","bind","onprogress","onProgress","open","send","resume","secondsHeadroom","worstCaseLoadingTime","loadTime","destroy","abort","end","Math","min","Now","status","onChunkLoad","response","loadFails","setRequestHeader","responseType","ev","loaded","total","data","byteLength","write"],"mappings":"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","file":"ajax-progressive.js","sourcesContent":["import JSMpeg from './jsmpeg';\r\n\r\nlet AjaxProgressiveSource = function(url, options) {\r\n\tthis.url = url;\r\n\tthis.destination = null;\r\n\tthis.request = null;\r\n\r\n\tthis.completed = false;\r\n\tthis.established = false;\r\n\tthis.progress = 0;\r\n\r\n\tthis.fileSize = 0;\r\n\tthis.loadedSize = 0;\r\n\tthis.chunkSize = options.chunkSize || 1024*1024;\r\n\r\n\tthis.isLoading = false;\r\n\tthis.loadStartTime = 0;\r\n\tthis.throttled = options.throttled !== false;\r\n\tthis.aborted = false;\r\n};\r\n\r\nAjaxProgressiveSource.prototype.connect = function(destination) {\r\n\tthis.destination = destination;\r\n};\r\n\r\nAjaxProgressiveSource.prototype.start = function() {\r\n\tthis.request = new XMLHttpRequest();\r\n\r\n\tthis.request.onreadystatechange = function() {\r\n\t\tif (this.request.readyState === this.request.DONE) {\r\n\t\t\tthis.fileSize = parseInt(\r\n\t\t\t\tthis.request.getResponseHeader(\"Content-Length\")\r\n\t\t\t);\r\n\t\t\tthis.loadNextChunk();\r\n\t\t}\r\n\t}.bind(this);\r\n\r\n\tthis.request.onprogress = this.onProgress.bind(this);\r\n\tthis.request.open('HEAD', this.url);\r\n\tthis.request.send();\r\n};\r\n\r\nAjaxProgressiveSource.prototype.resume = function(secondsHeadroom) {\r\n\tif (this.isLoading || !this.throttled) {\r\n\t\treturn;\r\n\t}\r\n\r\n\t// Guess the worst case loading time with lots of safety margin. This is\r\n\t// somewhat arbitrary...\r\n\tvar worstCaseLoadingTime = this.loadTime * 8 + 2;\r\n\tif (worstCaseLoadingTime > secondsHeadroom) {\r\n\t\tthis.loadNextChunk();\r\n\t}\r\n};\r\n\r\nAjaxProgressiveSource.prototype.destroy = function() {\r\n\tthis.request.abort();\r\n\tthis.aborted = true;\r\n};\r\n\r\nAjaxProgressiveSource.prototype.loadNextChunk = function() {\r\n\tvar start = this.loadedSize,\r\n\t\tend = Math.min(this.loadedSize + this.chunkSize-1, this.fileSize-1);\r\n\t\r\n\tif (start >= this.fileSize || this.aborted) {\r\n\t\tthis.completed = true;\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tthis.isLoading = true;\r\n\tthis.loadStartTime = JSMpeg.Now();\r\n\tthis.request = new XMLHttpRequest();\r\n\r\n\tthis.request.onreadystatechange = function() {\t\t\r\n\t\tif (\r\n\t\t\tthis.request.readyState === this.request.DONE && \r\n\t\t\tthis.request.status >= 200 && this.request.status < 300\r\n\t\t) {\r\n\t\t\tthis.onChunkLoad(this.request.response);\r\n\t\t}\r\n\t\telse if (this.request.readyState === this.request.DONE) {\r\n\t\t\t// Retry?\r\n\t\t\tif (this.loadFails++ < 3) {\r\n\t\t\t\tthis.loadNextChunk();\r\n\t\t\t}\r\n\t\t}\r\n\t}.bind(this);\r\n\t\r\n\tif (start === 0) {\r\n\t\tthis.request.onprogress = this.onProgress.bind(this);\r\n\t}\r\n\r\n\tthis.request.open('GET', this.url+'?'+start+\"-\"+end);\r\n\tthis.request.setRequestHeader(\"Range\", \"bytes=\"+start+\"-\"+end);\r\n\tthis.request.responseType = \"arraybuffer\";\r\n\tthis.request.send();\r\n};\r\n\r\nAjaxProgressiveSource.prototype.onProgress = function(ev) {\r\n\tthis.progress = (ev.loaded / ev.total);\r\n};\r\n\r\nAjaxProgressiveSource.prototype.onChunkLoad = function(data) {\r\n\tthis.established = true;\r\n\tthis.progress = 1;\r\n\tthis.loadedSize += data.byteLength;\r\n\tthis.loadFails = 0;\r\n\tthis.isLoading = false;\r\n\r\n\tif (this.destination) {\r\n\t\tthis.destination.write(data);\r\n\t}\r\n\r\n\tthis.loadTime = JSMpeg.Now() - this.loadStartTime;\r\n\tif (!this.throttled) {\r\n\t\tthis.loadNextChunk();\r\n\t}\r\n};\r\n\r\nexport default AjaxProgressiveSource;\r\n"]}